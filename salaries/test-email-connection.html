<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Email Connection Diagnostic Tool</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .card {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        h1 { color: #2c3e50; }
        h2 { color: #34495e; margin-top: 20px; }
        .status { padding: 15px; border-radius: 5px; margin: 10px 0; }
        .success { background: #d4edda; border-left: 4px solid #28a745; }
        .error { background: #f8d7da; border-left: 4px solid #dc3545; }
        .warning { background: #fff3cd; border-left: 4px solid #ffc107; }
        .info { background: #d1ecf1; border-left: 4px solid #17a2b8; }
        button {
            background: #4CAF50;
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
        }
        button:hover { background: #45a049; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        .btn-test { background: #2196F3; }
        .btn-test:hover { background: #0b7dda; }
        #log {
            background: #263238;
            color: #aed581;
            padding: 15px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        input {
            width: 100%;
            padding: 10px;
            margin: 5px 0 15px 0;
            border: 1px solid #ddd;
            border-radius: 5px;
            box-sizing: border-box;
        }
        label {
            font-weight: bold;
            color: #555;
        }
        code {
            background: #f4f4f4;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
        }
    </style>
</head>
<body>
    <div class="card">
        <h1>üìß Email Connection Diagnostic Tool</h1>
        <p>This tool will help diagnose email sending issues in the Payroll System.</p>
    </div>

    <div class="card">
        <h2>Step 1: Check Your Access Method</h2>
        <div id="urlCheck" class="status info">
            <strong>Current URL:</strong> <span id="currentUrl"></span><br>
            <strong>Protocol:</strong> <span id="protocol"></span>
        </div>
        <div id="urlAdvice"></div>
    </div>

    <div class="card">
        <h2>Step 2: Enter Gmail Credentials</h2>
        <label>Gmail Address:</label>
        <input type="email" id="gmailAddress" placeholder="youremail@gmail.com">
        
        <label>Gmail App Password:</label>
        <input type="password" id="gmailPassword" placeholder="xvhd ivej jdsf lxaf">
        
        <label>Sender Name:</label>
        <input type="text" id="senderName" value="East Boundary Systems - Payroll">
    </div>

    <div class="card">
        <h2>Step 3: Test PHP Connection</h2>
        <button class="btn-test" onclick="testPHPConnection()">Test PHP File Access</button>
        <button class="btn-test" onclick="testEmailSending()">Test Email Sending</button>
        <div id="testResult"></div>
    </div>

    <div class="card">
        <h2>Diagnostic Log</h2>
        <div id="log"></div>
    </div>

    <script>
        const log = document.getElementById('log');
        
        function addLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const icon = type === 'error' ? '‚ùå' : type === 'success' ? '‚úÖ' : type === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è';
            log.innerHTML += `[${timestamp}] ${icon} ${message}\n`;
            log.scrollTop = log.scrollHeight;
        }

        // Check URL on load
        window.onload = function() {
            const url = window.location.href;
            const protocol = window.location.protocol;
            
            document.getElementById('currentUrl').textContent = url;
            document.getElementById('protocol').textContent = protocol;
            
            addLog('Page loaded');
            addLog('Current URL: ' + url);
            addLog('Protocol: ' + protocol);
            
            const urlAdvice = document.getElementById('urlAdvice');
            
            if (protocol === 'file:') {
                urlAdvice.innerHTML = `
                    <div class="status error">
                        <strong>‚ö†Ô∏è WARNING: You are opening this file directly (file:// protocol)</strong><br>
                        For emails to work, you must access via Apache:<br>
                        <code>http://localhost/eastboundarysystems/salaries/index.html</code>
                    </div>
                `;
                addLog('WARNING: file:// protocol detected. PHP will not work!', 'warning');
            } else if (url.includes('localhost') || url.includes('127.0.0.1')) {
                urlAdvice.innerHTML = `
                    <div class="status success">
                        <strong>‚úÖ GOOD: You are accessing via Apache (localhost)</strong><br>
                        PHP should work correctly.
                    </div>
                `;
                addLog('‚úì Localhost detected. PHP should work.', 'success');
            } else {
                urlAdvice.innerHTML = `
                    <div class="status warning">
                        <strong>‚ÑπÔ∏è INFO: You are accessing via: ${protocol}</strong><br>
                        Make sure Apache is running and PHP is configured.
                    </div>
                `;
            }
        };

        async function testPHPConnection() {
            addLog('Testing PHP file access...');
            const testResult = document.getElementById('testResult');
            
            try {
                const fetchUrl = window.location.protocol === 'file:' ? 
                    'http://localhost/eastboundarysystems/salaries/send-email.php' : 
                    'send-email.php';
                
                addLog('Fetch URL: ' + fetchUrl);
                
                const response = await fetch(fetchUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ test: true })
                });
                
                addLog('Response status: ' + response.status + ' ' + response.statusText);
                
                const text = await response.text();
                addLog('Response body (first 200 chars): ' + text.substring(0, 200));
                
                if (response.ok) {
                    testResult.innerHTML = `<div class="status success">‚úÖ PHP file is accessible! Status: ${response.status}</div>`;
                    addLog('‚úì PHP file accessible', 'success');
                } else {
                    testResult.innerHTML = `<div class="status error">‚ùå PHP file returned error: ${response.status}<br>Response: ${text.substring(0, 200)}</div>`;
                    addLog('‚úó PHP error: ' + response.status, 'error');
                }
                
            } catch (error) {
                testResult.innerHTML = `<div class="status error">‚ùå Cannot reach PHP file: ${error.message}</div>`;
                addLog('‚úó Fetch failed: ' + error.message, 'error');
            }
        }

        async function testEmailSending() {
            addLog('Testing email sending...');
            const testResult = document.getElementById('testResult');
            
            const gmailAddress = document.getElementById('gmailAddress').value.trim();
            const gmailPassword = document.getElementById('gmailPassword').value.trim();
            const senderName = document.getElementById('senderName').value.trim();
            
            if (!gmailAddress) {
                testResult.innerHTML = `<div class="status error">‚ùå Please enter Gmail address</div>`;
                addLog('‚úó Gmail address missing', 'error');
                return;
            }
            
            if (!gmailPassword) {
                testResult.innerHTML = `<div class="status error">‚ùå Please enter Gmail App Password</div>`;
                addLog('‚úó Gmail password missing', 'error');
                return;
            }
            
            addLog('Gmail: ' + gmailAddress);
            addLog('Password length: ' + gmailPassword.length);
            addLog('Sender: ' + senderName);
            
            try {
                const fetchUrl = window.location.protocol === 'file:' ? 
                    'http://localhost/eastboundarysystems/salaries/send-email.php' : 
                    'send-email.php';
                
                addLog('Sending request to: ' + fetchUrl);
                
                testResult.innerHTML = `<div class="status info">üîÑ Sending test email... Please wait.</div>`;
                
                const response = await fetch(fetchUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        gmailAddress: gmailAddress,
                        gmailPassword: gmailPassword,
                        senderName: senderName,
                        recipientEmail: gmailAddress,
                        recipientName: 'Test User',
                        subject: 'Test Email - Payroll System',
                        message: '<h2>Test Email</h2><p>Your email configuration is working!</p>',
                        pdfData: '',
                        pdfFilename: ''
                    })
                });
                
                addLog('Response status: ' + response.status + ' ' + response.statusText);
                
                const text = await response.text();
                addLog('Response body: ' + text);
                
                try {
                    const result = JSON.parse(text);
                    
                    if (result.success) {
                        testResult.innerHTML = `<div class="status success">‚úÖ Email sent successfully! Check your Gmail inbox.</div>`;
                        addLog('‚úì Email sent successfully!', 'success');
                    } else {
                        testResult.innerHTML = `<div class="status error">‚ùå Email failed: ${result.error || 'Unknown error'}</div>`;
                        addLog('‚úó Email failed: ' + (result.error || 'Unknown'), 'error');
                    }
                } catch (e) {
                    testResult.innerHTML = `<div class="status error">‚ùå Server returned non-JSON response:<br><pre>${text.substring(0, 500)}</pre></div>`;
                    addLog('‚úó Invalid JSON response', 'error');
                }
                
            } catch (error) {
                testResult.innerHTML = `<div class="status error">‚ùå Request failed: ${error.message}</div>`;
                addLog('‚úó Request error: ' + error.message, 'error');
            }
        }
    </script>
</body>
</html>
